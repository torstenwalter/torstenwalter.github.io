<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.2">Jekyll</generator><link href="https://torstenwalter.de/feed.xml" rel="self" type="application/atom+xml" /><link href="https://torstenwalter.de/" rel="alternate" type="text/html" /><updated>2024-09-03T07:28:34+00:00</updated><id>https://torstenwalter.de/feed.xml</id><title type="html">Torsten Walter - technical notes</title><subtitle>A blog about technical stuff I am working on in my spare time e.g. continuous integration (CI), continuous deployment, Jenkins, Docker and OpenShift.
</subtitle><author><name>Torsten Walter</name></author><entry><title type="html">How to install VirtualBox on Ubuntu 18.04 when secure boot is active</title><link href="https://torstenwalter.de/virtualbox/ubuntu/2019/06/13/install-virtualbox-ubuntu-secure-boot.html" rel="alternate" type="text/html" title="How to install VirtualBox on Ubuntu 18.04 when secure boot is active" /><published>2019-06-13T18:00:00+00:00</published><updated>2019-06-13T18:00:00+00:00</updated><id>https://torstenwalter.de/virtualbox/ubuntu/2019/06/13/install-virtualbox-ubuntu-secure-boot</id><content type="html" xml:base="https://torstenwalter.de/virtualbox/ubuntu/2019/06/13/install-virtualbox-ubuntu-secure-boot.html"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo update-secureboot-policy --new-key
find $(dirname $(modinfo -n vboxdrv)) -name "*.ko" -exec sudo kmodsign sha512 /var/lib/shim-signed/mok/MOK.priv /var/lib/shim-signed/mok/MOK.der {} \;
sudo update-secureboot-policy --enroll-key
</code></pre></div></div>

<h1 id="generate-a-key-for-signing-your-kernel-modules">Generate a key for signing your kernel modules:</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj "/CN=DKMS signing key/"

sudo mokutil --import MOK.der

sudo mv MOK.* /root/
</code></pre></div></div>

<p>http://lektiondestages.blogspot.com/2018/04/signing-your-kernel-modules-on-ubuntu.html</p>

<h1 id="reboot-and-add-the-key">Reboot and add the key</h1>

<blockquote>
  <p>You will be presented a blue text screen. Choose “Enroll MOK”, then you can choose to view your key or just “Continue”. Choose “Yes” and input the password from before. Your key should be added now and you can reboot.</p>
</blockquote>

<p>http://lektiondestages.blogspot.com/2018/04/signing-your-kernel-modules-on-ubuntu.html</p>

<h1 id="sign-the-virtualbox-kernel-modules">Sign the virtualbox kernel modules</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find $(dirname $(modinfo -n vboxdrv)) -name "*.ko" -exec sudo kmodsign sha512 /root/MOK.priv /root/MOK.der {} \;
</code></pre></div></div>

<h1 id="load-the-kernel-modules">Load the kernel modules</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modprobe vboxdrv
</code></pre></div></div>]]></content><author><name>Torsten Walter</name></author><category term="virtualbox" /><category term="ubuntu" /><summary type="html"><![CDATA[sudo update-secureboot-policy --new-key find $(dirname $(modinfo -n vboxdrv)) -name "*.ko" -exec sudo kmodsign sha512 /var/lib/shim-signed/mok/MOK.priv /var/lib/shim-signed/mok/MOK.der {} \; sudo update-secureboot-policy --enroll-key]]></summary></entry><entry><title type="html">How to use nginx as a sidecar container to encrypt network traffic in OpenShift?</title><link href="https://torstenwalter.de/openshift/nginx/sidecar/tls/encryption/certificates/2017/08/07/nginx-as-sidecar-container-to-secure-openshift-traffic.html" rel="alternate" type="text/html" title="How to use nginx as a sidecar container to encrypt network traffic in OpenShift?" /><published>2017-08-07T10:00:00+00:00</published><updated>2017-08-07T10:00:00+00:00</updated><id>https://torstenwalter.de/openshift/nginx/sidecar/tls/encryption/certificates/2017/08/07/nginx-as-sidecar-container-to-secure-openshift-traffic</id><content type="html" xml:base="https://torstenwalter.de/openshift/nginx/sidecar/tls/encryption/certificates/2017/08/07/nginx-as-sidecar-container-to-secure-openshift-traffic.html"><![CDATA[<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#basic_template_with_tls_termination_at_the_edge_router">Basic template with TLS termination at the edge router</a></li>
<li><a href="#enhanced_template_with_tls_encryption_from_the_edge_router_to_the_application">Enhanced template with TLS encryption from the edge router to the application</a>
<ul class="sectlevel2">
<li><a href="#add_nginx_image">Add nginx image</a></li>
<li><a href="#forward_the_traffic_to_our_application">Forward the traffic to our application</a></li>
<li><a href="#securing_traffic_from_the_edge_router_to_nginx">Securing traffic from the edge router to nginx</a></li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<p>OpenShift allows you to secure your applications by using secured routes. This way TLS termination
can be done at the edge router and traffic from the outside to your router is encrypted.</p>
</div>
<div class="paragraph">
<p>Traffic from the router to the application is still unencrypted. If you want added security it&#8217;s possible to encrypt
this traffic as well. This article shows you how nginx can be used as a sidecar container to do the tls termination for
your pod.</p>
</div>
<div class="sect1">
<h2 id="basic_template_with_tls_termination_at_the_edge_router">Basic template with TLS termination at the edge router</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s start with a simple deployment template: consisting og: A deployment config, one service and a route which is configured to do tls termination.</p>
</div>
<div class="paragraph">
<p>generic-template.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Template
metadata:
  name: generic-template
  annotations:
    description: "A generic template which creates a DeploymentConfig, Service and Route for a given docker image"
    tags: "webserver"
objects:
- apiVersion: v1
  kind: DeploymentConfig <i class="conum" data-value="1"></i><b>(1)</b>
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    replicas: 1
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
    template:
      metadata:
        labels:
          app: ${NAME}
          deploymentconfig: ${NAME}
      spec:
        containers:
        - image: ${DOCKER_IMAGE}
          imagePullPolicy: Always
          name: application
          ports:
          - containerPort: "${{CONTAINER_PORT}}"
            protocol: TCP
          terminationMessagePath: /dev/termination-log
    triggers: {}
- apiVersion: v1
  kind: Service <i class="conum" data-value="2"></i><b>(2)</b>
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    ports:
    - port: "${{CONTAINER_PORT}}"
      protocol: TCP
      targetPort: "${{CONTAINER_PORT}}"
      name: http
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
- apiVersion: v1
  kind: Route <i class="conum" data-value="3"></i><b>(3)</b>
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    port:
      targetPort: "${{CONTAINER_PORT}}"
    to:
      kind: Service
      name: ${NAME}
    tls:
      termination: edge
parameters:
- name: NAME
  description: The name for the deployment config, service and route
  required: true
- name: DOCKER_IMAGE
  description:
  required: true
- name: CONTAINER_PORT
  description: The port which will be exposed as service and route
  value: "8080"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template is contains the following components:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A deployment config which uses the <code>NAME</code> and <code>DOCKER_IMAGE</code> parameters to run the application and specified the <code>CONTAINER_PORT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A service routing traffic to the pod(s) instantiated by the DeploymentConfig.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A route exposing the service and doing tls termination at the <code>edge</code> router.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use this template by applying the parameters and starting a manual deployment (as the triggers are set to be empty).
The example below uses it to instantiate a jenkins instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc process -f generic-template.yml NAME=jenkins DOCKER_IMAGE=openshift/jenkins-2-centos7:latest|oc apply -f -
oc rollout latest dc/jenkins</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a short moment the application should be running and being accessible via https.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enhanced_template_with_tls_encryption_from_the_edge_router_to_the_application">Enhanced template with TLS encryption from the edge router to the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have the application running we can extend the template to include nginx as a second container in our
deployment which should do TLS termination for traffic from the edge router and forward it to our application. As both
containers are part of the same POD they will be placed on the same node and one can reach each other via localhost and
no network traffic between the two goes over the wire.</p>
</div>
<div class="sect2">
<h3 id="add_nginx_image">Add nginx image</h3>
<div class="paragraph">
<p>As first step let&#8217;s add the nginx image and route traffice to nginx instead of our container.
This way we can check if nginx is working.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Template
metadata:
  name: generic-template
  annotations:
    description: "A generic template which creates a DeploymentConfig, Service and Route for a given docker image"
    tags: "webserver"
objects:
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    replicas: 1
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
    template:
      metadata:
        labels:
          app: ${NAME}
          deploymentconfig: ${NAME}
      spec:
        containers:
        - image: ${DOCKER_IMAGE}
          imagePullPolicy: Always
          name: application
          ports:
          - containerPort: "${{CONTAINER_PORT}}"
            protocol: TCP
          terminationMessagePath: /dev/termination-log
        - image: twalter/openshift-nginx:stable-alpine <i class="conum" data-value="1"></i><b>(1)</b>
          imagePullPolicy: Always                      <i class="conum" data-value="1"></i><b>(1)</b>
          name: nginx                                  <i class="conum" data-value="1"></i><b>(1)</b>
          ports:                                       <i class="conum" data-value="1"></i><b>(1)</b>
          - containerPort: 8081                        <i class="conum" data-value="1"></i><b>(1)</b>
            protocol: TCP                              <i class="conum" data-value="1"></i><b>(1)</b>
    triggers: {}
- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    ports:
    - port: 8081       <i class="conum" data-value="2"></i><b>(2)</b>
      protocol: TCP
      targetPort: 8081 <i class="conum" data-value="2"></i><b>(2)</b>
      name: http
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
- apiVersion: v1
  kind: Route
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    port:
      targetPort: 8081 <i class="conum" data-value="2"></i><b>(2)</b>
    to:
      kind: Service
      name: ${NAME}
    tls:
      termination: edge
parameters:
- name: NAME
  description: The name for the deployment config, service and route
  required: true
- name: DOCKER_IMAGE
  description:
  required: true
- name: CONTAINER_PORT
  description: The port which will be exposed as service and route
  value: "8080"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These lines add nginx and expose port 8081. Notice that we use twalter/openshift-nginx instead of nginx, because the official one does not run on OpenShift.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Forward all traffic to port 8081 where nginx is listening.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can now apply this template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc process -f generic-template.yml NAME=jenkins DOCKER_IMAGE=openshift/jenkins-2-centos7:latest|oc apply -f -
oc rollout latest dc/jenkins</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should see a "Welcome to nginx!" page.</p>
</div>
</div>
<div class="sect2">
<h3 id="forward_the_traffic_to_our_application">Forward the traffic to our application</h3>
<div class="paragraph">
<p>Now that nginx is running we can configure it to forward incoming requests to our application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Template
metadata:
  name: generic-template
  annotations:
    description: "A generic template which creates a DeploymentConfig, Service and Route for a given docker image"
    tags: "webserver"
objects:
- kind: ConfigMap                           <i class="conum" data-value="1"></i><b>(1)</b>
  apiVersion: v1                            <i class="conum" data-value="1"></i><b>(1)</b>
  metadata:                                 <i class="conum" data-value="1"></i><b>(1)</b>
    name: ${NAME}-nginx-config              <i class="conum" data-value="1"></i><b>(1)</b>
  data:                                     <i class="conum" data-value="1"></i><b>(1)</b>
    app-nginx.conf: |                       <i class="conum" data-value="1"></i><b>(1)</b>
      server {                              <i class="conum" data-value="1"></i><b>(1)</b>
        listen 8081;                        <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
        index index.html index.htm;         <i class="conum" data-value="1"></i><b>(1)</b>

        location / {                        <i class="conum" data-value="1"></i><b>(1)</b>
         proxy_pass http://localhost:8080/; <i class="conum" data-value="1"></i><b>(1)</b>
        }                                   <i class="conum" data-value="1"></i><b>(1)</b>
      }                                     <i class="conum" data-value="1"></i><b>(1)</b>
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    replicas: 1
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
    template:
      metadata:
        labels:
          app: ${NAME}
          deploymentconfig: ${NAME}
      spec:
        containers:
        - image: ${DOCKER_IMAGE}
          imagePullPolicy: Always
          name: application
          ports:
          - containerPort: "${{CONTAINER_PORT}}"
            protocol: TCP
          terminationMessagePath: /dev/termination-log
        - image: twalter/openshift-nginx:stable-alpine
          imagePullPolicy: Always
          name: nginx
          ports:
          - containerPort: 8081
            protocol: TCP
          volumeMounts:                       <i class="conum" data-value="4"></i><b>(4)</b>
          - mountPath: /etc/nginx/conf.d/     <i class="conum" data-value="4"></i><b>(4)</b>
            name: nginx-config-volume <i class="conum" data-value="4"></i><b>(4)</b>
        initContainers:
        - name: init-mydb
          image: busybox
          command: ['sh', '-c', 'until nslookup mydb; do echo waiting for mydb; sleep 2; done;']
        volumes:                             <i class="conum" data-value="3"></i><b>(3)</b>
        - configMap:                         <i class="conum" data-value="3"></i><b>(3)</b>
            defaultMode: 420                 <i class="conum" data-value="3"></i><b>(3)</b>
            name: ${NAME}-nginx-config       <i class="conum" data-value="3"></i><b>(3)</b>
          name: nginx-config-volume  <i class="conum" data-value="3"></i><b>(3)</b>
    triggers: {}
- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    ports:
    - port: 8081
      protocol: TCP
      targetPort: 8081
      name: http
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
- apiVersion: v1
  kind: Route
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    port:
      targetPort: 8081
    to:
      kind: Service
      name: ${NAME}
    tls:
      termination: edge
parameters:
- name: NAME
  description: The name for the deployment config, service and route
  required: true
- name: DOCKER_IMAGE
  description:
  required: true
- name: CONTAINER_PORT
  description: The port which will be exposed as service and route
  value: "8080"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use a config map to provide the nginx configuration file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note that the port is hardcoded in the file so it needs to be adapted in case your application uses a different one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the config map as volume</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Mount the volume into the nginx container</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After applying this template we should see the our application again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc process -f generic-template.yml NAME=jenkins DOCKER_IMAGE=openshift/jenkins-2-centos7:latest|oc apply -f -
oc rollout latest dc/jenkins</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should see a "Welcome to nginx!" page.</p>
</div>
</div>
<div class="sect2">
<h3 id="securing_traffic_from_the_edge_router_to_nginx">Securing traffic from the edge router to nginx</h3>
<div class="paragraph">
<p>Service serving certificate secrets
First of all we need a certificate in order to do TLS. Luckily OpenShift has a feature called <a href="https://docs.openshift.com/online/dev_guide/secrets.html#service-serving-certificate-secrets">Service Serving Certificate Secrets</a>
which allows to generate certificates. All we need to do is to add the annotation as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
    annotations:                                                        <i class="conum" data-value="1"></i><b>(1)</b>
      service.alpha.openshift.io/serving-cert-secret-name: ${NAME}-cert <i class="conum" data-value="1"></i><b>(1)</b>
  spec:
    ports:
    - port: "${{CONTAINER_PORT}}"
      protocol: TCP
      targetPort: "${{CONTAINER_PORT}}"
      name: http
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The necessary annotation to let OpenShift generate a certificate for us.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we apply this configuration we can check if the secret has been generated for us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc get secrets -o name

secret/builder-dockercfg-vdw69
secret/builder-token-303tx
secret/builder-token-l1npj
secret/default-dockercfg-2mndj
secret/default-token-bxvrc
secret/default-token-t0c70
secret/deployer-dockercfg-7dbgn
secret/deployer-token-1r1fk
secret/deployer-token-k4qq7
secret/jenkins-cert <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>generated tls secret</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s use this certificate to secure nginx:</p>
</div>
<div class="paragraph">
<p>generic-template-with-internal-encryption.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Template
metadata:
  name: generic-template
  annotations:
    description: "A generic template which creates a DeploymentConfig, Service and Route for a given docker image"
    tags: "webserver"
objects:
- kind: ConfigMap
  apiVersion: v1
  metadata:
    name: ${NAME}-nginx-config
  data:
    app-nginx.conf: |
      server {
        listen 8443 ssl;                               <i class="conum" data-value="4"></i><b>(4)</b>
        ssl_certificate /etc/nginx/certs/tls.crt;      <i class="conum" data-value="4"></i><b>(4)</b>
        ssl_certificate_key /etc/nginx/certs/tls.key;  <i class="conum" data-value="4"></i><b>(4)</b>
        index index.html index.htm;

        location / {
         proxy_pass http://localhost:8080/;
        }
      }
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    replicas: 1
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
    template:
      metadata:
        labels:
          app: ${NAME}
          deploymentconfig: ${NAME}
      spec:
        containers:
        - image: ${DOCKER_IMAGE}
          imagePullPolicy: Always
          name: application
          ports:
          - containerPort: "${{CONTAINER_PORT}}"
            protocol: TCP
          terminationMessagePath: /dev/termination-log
        - image: twalter/openshift-nginx:stable-alpine
          imagePullPolicy: Always
          name: nginx
          ports:
          - containerPort: 8443 <i class="conum" data-value="5"></i><b>(5)</b>
            protocol: TCP
          volumeMounts:
          - mountPath: /etc/nginx/conf.d/
            name: nginx-config-volume
          - mountPath: /etc/nginx/certs  <i class="conum" data-value="3"></i><b>(3)</b>
            name: nginx-cert-volume      <i class="conum" data-value="3"></i><b>(3)</b>
        initContainers:
        - name: init-mydb
          image: busybox
          command: ['sh', '-c', 'until nslookup mydb; do echo waiting for mydb; sleep 2; done;']
        volumes:
        - configMap:
            defaultMode: 420
            name: ${NAME}-nginx-config
          name: nginx-config-volume
        - secret:                    <i class="conum" data-value="2"></i><b>(2)</b>
            secretName: ${NAME}-cert <i class="conum" data-value="2"></i><b>(2)</b>
          name: nginx-cert-volume    <i class="conum" data-value="2"></i><b>(2)</b>
    triggers: {}
- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
    annotations:
      service.alpha.openshift.io/serving-cert-secret-name: ${NAME}-cert  <i class="conum" data-value="1"></i><b>(1)</b>
  spec:
    ports:
    - port: 8443 <i class="conum" data-value="5"></i><b>(5)</b>
      protocol: TCP
      targetPort: 8443 <i class="conum" data-value="5"></i><b>(5)</b>
      name: http
    selector:
      app: ${NAME}
      deploymentconfig: ${NAME}
- apiVersion: v1
  kind: Route
  metadata:
    labels:
      app: ${NAME}
    name: ${NAME}
  spec:
    port:
      targetPort: 8443 <i class="conum" data-value="5"></i><b>(5)</b>
    to:
      kind: Service
      name: ${NAME}
    tls:
      termination: reencrypt  <i class="conum" data-value="6"></i><b>(6)</b>
      insecureEdgeTerminationPolicy: Redirect <i class="conum" data-value="8"></i><b>(8)</b>
      destinationCACertificate: |-            <i class="conum" data-value="7"></i><b>(7)</b>
        -----BEGIN CERTIFICATE-----
        MIIC6jCCAdKgAwIBAgIBATANBgkqhkiG9w0BAQsFADAmMSQwIgYDVQQDDBtvcGVu
        c2hpZnQtc2lnbmVyQDE1MDE1OTkwMjIwHhcNMTcwODAxMTQ1MDIxWhcNMjIwNzMx
        MTQ1MDIyWjAmMSQwIgYDVQQDDBtvcGVuc2hpZnQtc2lnbmVyQDE1MDE1OTkwMjIw
        ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC82yK5Tbda+qrQy3NTuJPK
        UchalxsHafqNGz1b0iWFhD+kUovTPBZw67qfIbH7Rl+sVYECUXmWrkI3ctbr5ZXd
        en2WDl5SsAjNodRiYHbxXGOEUUGhwykpWaD0+SxuA9ZNrMEGzxJlueSfhC1zWKE6
        HR+q5lfxlFyY0/+BX2AgmvQDWS9fElwgnbLc+pQSfHAWFQ+ic7pPemxh468WjTIY
        N2mT4lHLgjYRNf7GpC5TrNaA5FrUZ8hIevjtrlKDaSJian6rjJOinuACI2iQmHDm
        e91LJLVvZmhiehwMGyAuDqaCvPBHF8TwNxFzj5TUzCY3c9Kr8HeClHxUhTYRsD+h
        AgMBAAGjIzAhMA4GA1UdDwEB/wQEAwICpDAPBgNVHRMBAf8EBTADAQH/MA0GCSqG
        SIb3DQEBCwUAA4IBAQAF6uaque2iQ7RD4sqoziIIKVaHgc4YFfOfRkt9ZQ4Fhd6R
        VJKduVcqeBYPuzgXkPn/qZRDEVOTxwu7luqBg/+nbShKZ1fIT4/gKaSzQVFW/wPP
        vWfTHrWTPbeYNBq2/00BkpGRT2M9T/KOKOVwmfN7x7uPdsmuThRlKpnb3we3riql
        PogX0pjvyggLv0gREKWKiRSFg9ngZfLuQR0nxvbRxRoPVaefQwTr9GTIU69SWxWX
        fyuoKFEGWbVN+DGCfPLRXMfvpxLjJiYoMK9VdL1rPX+C5evlDnA+U8MQhek+PgH5
        BNGyLtH/x68Y+wQ4k4m8A/+/Lp43r8n5e1Kb5R/w
        -----END CERTIFICATE-----

        -----BEGIN CERTIFICATE-----
        MIIDCjCCAfKgAwIBAgIBATANBgkqhkiG9w0BAQsFADA2MTQwMgYDVQQDDCtvcGVu
        c2hpZnQtc2VydmljZS1zZXJ2aW5nLXNpZ25lckAxNTAxNTk5MDIyMB4XDTE3MDgw
        MTE0NTAyMloXDTIyMDczMTE0NTAyM1owNjE0MDIGA1UEAwwrb3BlbnNoaWZ0LXNl
        cnZpY2Utc2VydmluZy1zaWduZXJAMTUwMTU5OTAyMjCCASIwDQYJKoZIhvcNAQEB
        BQADggEPADCCAQoCggEBAKxHhXqzbxfzHCT0gDQEVbnJvMVs+KVvYK9sP20sGhua
        9rJR9S8CaRhFWsqC7R0FxMfJgWKeLU2IXC7cPKNjYVpC5Yp8jkSXsd9fRXOuky5F
        WW+FYUBWSZwgSdASk33pqUYllcNUbpVJWCPYVJOX1Gh4Pra8GrycgbcNOYm40mYb
        +nJFzjON9ISBIdinclS545aK9FVbJesy4Gia8zOItiKakZLFLP9shQjTDS5mliWe
        pl0wBaB7h/Cg7aI3/SVlsABE1dJyxpd3fE0NhLdB70/+SNEIoDIc7o5gQsJHvF+e
        yXxNeNoVXQAaXE+bBKq2lJkA4ivZi3Vmf1BDSba7as0CAwEAAaMjMCEwDgYDVR0P
        AQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAHGi
        CfxsWysSLhHfIC2crIO5WoarBa3BrZapQhECe4pcI7mqISFPLVO5rpXx2iBw+QrK
        vjWeAd/8G9HueA7GcGkgolmcHHAJwJ/Xj9Kkt8exKxnfDoRwYHKBDaUA9w8HyFHx
        EMOlbNfaO2o2p1FcfZ1SCxoKcNhMt1mpOZVT9sGZV5o/x3o247GqZdIDrpLpz8xq
        Lv7/3WlLwOhkGfLPY8Vi+gZ24oeZijtReVM7WZ/SpQ2O/Xo+cfkUYnDxyibJ6NEl
        eIzIGQw80rLK72pYYwbcOFd1xOYQx2hsDAEY2wRP6QvLAtUHf+DrZj0xkHZmkolp
        QGPHERXkiLqNBtyY/Rk=
        -----END CERTIFICATE-----
parameters:
- name: NAME
  description: The name for the deployment config, service and route
  required: true
- name: DOCKER_IMAGE
  description:
  required: true
- name: CONTAINER_PORT
  description: The port which will be exposed as service and route
  value: "8080"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add annotation to the route to let OpenShift generate the certificate secret for us</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>configure secret as volume</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>mount the secret to our nginx container</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>update nginx configuration to listen on port 8443 using ssl with the provided certificates</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>use port 8443 instead of 8081 just to make clear that we are using encryption</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>tell openshift to re-encrypt incoming traffic to the router before forwarding it to the service</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>configure the certificate which should be used to validate the certificate used in nginx. You need to replace this
 certificate with the one from your installation. You can retrieve it from any pod by checking the file <code>/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt</code>.
In OpenShift 3.6 it should no longer be necessary to configure this when using service serving certificates.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>redirect insecure traffic to a secure schema (http &#8594; https)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s the complete template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc process -f generic-template-with-internal-encryption.yml NAME=jenkins DOCKER_IMAGE=openshift/jenkins-2-centos7:latest|oc apply -f -
oc rollout latest dc/jenkins</code></pre>
</div>
</div>
<div class="paragraph">
<p>After applying it connection you can access your application and the traffic to and from the edge router is encrypted.</p>
</div>
<div class="paragraph">
<p>Possible improvements: The port of the application should be injected into the nginx configuration as well.</p>
</div>
</div>
</div>
</div>]]></content><author><name>Torsten Walter</name></author><category term="openshift" /><summary type="html"><![CDATA[Describes how nginx can be used as sidecar container to secure network traffic inside OpenShift by using TLS encryption and service serving certificate secrets.]]></summary></entry><entry><title type="html">How to run nginx on OpenShift?</title><link href="https://torstenwalter.de/openshift/nginx/2017/08/04/nginx-on-openshift.html" rel="alternate" type="text/html" title="How to run nginx on OpenShift?" /><published>2017-08-04T11:00:00+00:00</published><updated>2017-08-04T11:00:00+00:00</updated><id>https://torstenwalter.de/openshift/nginx/2017/08/04/nginx-on-openshift</id><content type="html" xml:base="https://torstenwalter.de/openshift/nginx/2017/08/04/nginx-on-openshift.html"><![CDATA[<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#fix_file_and_directory_permissions">Fix file and directory permissions</a></li>
<li><a href="#fix_used_port">Fix used port</a></li>
<li><a href="#remove_user_directive">Remove user directive</a></li>
<li><a href="#dockerfile">Dockerfile</a></li>
<li><a href="#run_nginx_in_openshift">Run nginx in OpenShift</a></li>
</ul>
</div>
<div class="paragraph">
<p>The official <a href="http://nginx.org/">NGINX</a> docker container published on <a href="https://hub.docker.com/_/nginx/">docker hub</a> does not run on Openshift,
because of OpenShift security constraints. If you want to learn more about it continue reading otherwise you could jump directly to <a href="#run_nginx_in_openshift">Run nginx in OpenShift</a>.</p>
</div>
<div class="paragraph">
<p>To quote from <a href="https://docs.openshift.com/container-platform/3.5/creating_images/guidelines.html#openshift-container-platform-specific-guidelines">OpenShift Container Platform-Specific Guidelines</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Support Arbitrary User IDs</p>
</div>
<div class="paragraph">
<p>By default, OpenShift Container Platform runs containers using an arbitrarily assigned user ID. This provides additional security against processes escaping the container due to a container engine vulnerability and thereby achieving escalated permissions on the host node.</p>
</div>
<div class="paragraph">
<p>For an image to support running as an arbitrary user, directories and files that may be written to by processes in the image should be owned by the root group and be read/writable by that group. Files to be executed should also have group execute permissions.</p>
</div>
</blockquote>
</div>
<div class="sect1">
<h2 id="fix_file_and_directory_permissions">Fix file and directory permissions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s chack the nginx configuration file for possible file or directory permission problems.</p>
</div>
<div class="listingblock">
<div class="title">/etc/nginx/nginx.conf</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-nginx hljs" data-lang="nginx">user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn; <i class="conum" data-value="1"></i><b>(1)</b>
pid        /var/run/nginx.pid; <i class="conum" data-value="2"></i><b>(2)</b>


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types; <i class="conum" data-value="3"></i><b>(3)</b>
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main; <i class="conum" data-value="1"></i><b>(1)</b>

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf; <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>/var/log/nginx</code> - the directory for nginx logs needs to be writeable by group <code>root</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/var/run</code> - the nginx.pid file is written there so we need write permissions here is well</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>/etc/nginx/mime.types</code> - read permissions will do in this case</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>/etc/nginx/conf.d/</code> - as nginx should not write to configuration files read permissions are sufficient</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition nginx writes files to <code>/var/cache/nginx</code></p>
</div>
<div class="paragraph">
<p>Let&#8217;s check the permissions for these files and directories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>run the official nginx docker image:</p>
<div class="literalblock">
<div class="content">
<pre>docker run -it nginx:latest /bin/bash</pre>
</div>
</div>
</li>
<li>
<p>check the owner, group and permissions</p>
<div class="literalblock">
<div class="content">
<pre>ls -aldH /var/log/nginx /var/run /etc/nginx /etc/nginx/mime.types /etc/nginx/conf.d /var/cache/nginx</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>drwxr-xr-x 3 root root 4096 Jul 26 07:33 /etc/nginx
drwxr-xr-x 2 root root 4096 Jul 26 07:33 /etc/nginx/conf.d
-rw-r--r-- 1 root root 3957 Jul 11 13:06 /etc/nginx/mime.types
drwxr-xr-x 2 root root 4096 Jul 11 13:06 /var/cache/nginx
drwxr-xr-x 1 root root 4096 Jul 26 07:34 /var/log/nginx
drwxr-xr-x 4 root root 4096 Jul 23 00:00 /var/run</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see we need to correct the permissions for <code>/var/cache/nginx</code>, <code>/var/log/nginx</code> and <code>/var/run</code>. The neccessary command to do so is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>chmod g+rwx /var/cache/nginx /var/run /var/log/nginx</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fix_used_port">Fix used port</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A side effect of running as an arbitrary user we can&#8217;t listen to port 80 as the official nginx docker image does, as privileged ports can only be used by root.</p>
</div>
<div class="listingblock">
<div class="title">/etc/nginx/conf.d/default.conf</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-nginx hljs" data-lang="nginx">server {
    listen       80; <i class="conum" data-value="1"></i><b>(1)</b>
    server_name  localhost;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>listen port is 80</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can change the port unsing an in-place sed expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sed -i.bak 's/listen\(.*\)80;/listen 8081;/' /etc/nginx/conf.d/default.conf</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="remove_user_directive">Remove user directive</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you start nginx with the modifications from above the following error message is shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2017/08/04 06:51:55 [warn] 1#1: the "user" directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2
nginx: [warn] the "user" directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2</pre>
</div>
</div>
<div class="paragraph">
<p>This directive is listed on the first line of nginx.conf</p>
</div>
<div class="listingblock">
<div class="title">/etc/nginx/nginx.conf</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-nginx hljs" data-lang="nginx">user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can comment the user directive with a simple sed expression like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RUN sed -i.bak 's/^user/#user/' /etc/nginx/nginx.conf</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dockerfile">Dockerfile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following Dockerfile can be used to fix the problems with the official nginx docker image so that it can be run on OpenShift:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-docker hljs" data-lang="docker">FROM nginx:stable

# support running as arbitrary user which belogs to the root group
RUN chmod g+rwx /var/cache/nginx /var/run /var/log/nginx
# users are not allowed to listen on priviliged ports
RUN sed -i.bak 's/listen\(.*\)80;/listen 8081;/' /etc/nginx/conf.d/default.conf
EXPOSE 8081
# comment user directive as master process is run as user in OpenShift anyhow
RUN sed -i.bak 's/^user/#user/' /etc/nginx/nginx.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>So that you don&#8217;t have to do this I created docker images with these modifications in <a href="https://hub.docker.com/r/twalter/openshift-nginx/" class="bare">https://hub.docker.com/r/twalter/openshift-nginx/</a>.
The tags follow the official nginx tags. All images should automatically be rebuilt whenever the official nginx images are rebuilt.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run_nginx_in_openshift">Run nginx in OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So finally we can use nginx in OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app twalter/openshift-nginx:stable --name nginx-stable
oc expose svc nginx-stable --port=8081</pre>
</div>
</div>
<div class="paragraph">
<p>When you open the public route you should see the message "Welcome to nginx!".</p>
</div>
<div class="paragraph">
<p>Of course you can do the same with the other images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app twalter/openshift-nginx:latest --name nginx-latest
oc expose svc nginx-latest --port=8081</pre>
</div>
</div>
<div class="paragraph">
<p>The alpine versions are available as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app twalter/openshift-nginx:mainline-alpine --name nginx-mainline-alpine
oc expose svc nginx-mainline-alpine --port=8081</pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use a template to create a deployment config, service and route for nginx
you could use <a href="https://raw.githubusercontent.com/torstenwalter/openshift-nginx/master/tests/nginx-template.yml">this one</a> as basis. I am actually using it to test the built nginx images with
the modifications described above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc process -f https://raw.githubusercontent.com/torstenwalter/openshift-nginx/master/tests/nginx-template.yml NAME=nginx-stable-alpine NGINX_VERSION=stable-alpine |oc apply -f -</pre>
</div>
</div>
</div>
</div>]]></content><author><name>Torsten Walter</name></author><category term="openshift" /><summary type="html"><![CDATA[Changes needed in official nginx docker image to be able to run it on OpenShift (or Minishift).]]></summary></entry><entry><title type="html">How to install and configure fish shell on OSX</title><link href="https://torstenwalter.de/osx/shell/fish/2017/07/26/fish-shell.html" rel="alternate" type="text/html" title="How to install and configure fish shell on OSX" /><published>2017-07-26T10:00:00+00:00</published><updated>2017-07-26T10:00:00+00:00</updated><id>https://torstenwalter.de/osx/shell/fish/2017/07/26/fish-shell</id><content type="html" xml:base="https://torstenwalter.de/osx/shell/fish/2017/07/26/fish-shell.html"><![CDATA[<p><a href="https://fishshell.com/">fish</a> is a very nice shell with autocompletion out of the box. I find it extremely useful.
This explains how you can install it on OS X using homebrew and make it even better by using a popwerline style prompt.</p>

<h2 id="install-fish-shell">Install fish shell</h2>
<p>Let’s install it using brew</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install fish
</code></pre></div></div>

<p>Add <code class="language-plaintext highlighter-rouge">/usr/local/bin/fish</code> to <code class="language-plaintext highlighter-rouge">/etc/shells</code> if it is not alredy there:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /etc/shells|grep /usr/local/bin/fish ||sudo sh -c 'echo "/usr/local/bin/fish" &gt;&gt; /etc/shells'
</code></pre></div></div>

<p>make fish your default shell</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chsh -s /usr/local/bin/fish
</code></pre></div></div>

<h2 id="make-the-terminal-even-nicer-by-customizing-the-prompt">Make the terminal even nicer by customizing the prompt</h2>

<p>fish shell is already awesome, but we can make it even better by using a powerline style prompt which displays git branches,
the exit status of the last command, the current time  and much more.</p>

<p>To install it we are going to use Oh My Fish:</p>

<blockquote>
  <p>Oh My Fish provides core infrastructure to allow you to install packages which extend or modify the look of your shell. It’s fast, extensible and easy to use.</p>
</blockquote>

<p>Install <a href="https://github.com/oh-my-fish/oh-my-fish">oh-my-fish</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -L https://get.oh-my.fish | fish
</code></pre></div></div>

<p>Now we can use oh my fish to install bobthefish, which is a Powerline-style, Git aware fish theme.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>omf install bobthefish
</code></pre></div></div>

<p>Let’s make it even more awesome by installing nerd-fonts</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew tap caskroom/fonts
brew cask install font-hack-nerd-font
</code></pre></div></div>

<p>After that you should change the font of your terminal to <code class="language-plaintext highlighter-rouge">Knack Nerd Font</code> and enable them in bobthefish</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set -g theme_nerd_fonts yes
</code></pre></div></div>]]></content><author><name>Torsten Walter</name></author><category term="osx" /><category term="shell" /><category term="fish" /><summary type="html"><![CDATA[Explains how to install fishshell on OSX and configure a powerline style prompt.]]></summary></entry><entry><title type="html">How to build a docker image and upload it to Minishift’s docker registry?</title><link href="https://torstenwalter.de/minishift/openshift/docker/registry/2017/07/25/build-docker-image-and-upload-to-openshift-registry.html" rel="alternate" type="text/html" title="How to build a docker image and upload it to Minishift’s docker registry?" /><published>2017-07-25T13:30:00+00:00</published><updated>2017-07-25T13:30:00+00:00</updated><id>https://torstenwalter.de/minishift/openshift/docker/registry/2017/07/25/build-docker-image-and-upload-to-openshift-registry</id><content type="html" xml:base="https://torstenwalter.de/minishift/openshift/docker/registry/2017/07/25/build-docker-image-and-upload-to-openshift-registry.html"><![CDATA[<ul>
  <li>set docker environment variables to connect do Minishift docker daemon
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eval $(minishift docker-env)
</code></pre></div>    </div>
    <p>or when using fishshell</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eval (minishift docker-env)
</code></pre></div>    </div>
  </li>
  <li>login to openshift
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc login -u developer
</code></pre></div>    </div>
  </li>
  <li>login to the docker registry using the token from the currently logged-in openshift user
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login -u `oc whoami` -p `oc whoami -t` 172.30.1.1:5000
</code></pre></div>    </div>
    <p>or when using fishshell</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login -u (oc whoami) -p (oc whoami -t) 172.30.1.1:5000
</code></pre></div>    </div>
  </li>
  <li>build the docker image
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
</code></pre></div>    </div>
    <p>The output looks like:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Building jenkins
Step 1 : FROM registry.hub.docker.com/library/centos:centos7
 ---&gt; 36540f359ca3
Step 2 : ...
       ...
 ---&gt; a4628dc93c97
Successfully built a4628dc93c97
</code></pre></div>    </div>
  </li>
  <li>tag the newly created docker image
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag a4628dc93c97 172.30.1.1:5000/myproject/jenkins
</code></pre></div>    </div>
  </li>
  <li>push the image to the docker registry
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push 172.30.1.1:5000/myproject/jenkins
</code></pre></div>    </div>
  </li>
  <li>verify that the image was uploaded
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc get istag
</code></pre></div>    </div>
    <p>output:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME             DOCKER REF                                                                                                  UPDATED             IMAGENAME
jenkins:latest   172.30.1.1:5000/myproject/jenkins@sha256:6cab7386a27b2a8aa97d181f1d413d54a9fcb6dbfcf9b98d53bcff64ad05726b   About an hour ago   sha256:6cab7386a27b2a8aa97d181f1d413d54a9fcb6dbfcf9b98d53bcff64ad05726b
</code></pre></div>    </div>
  </li>
  <li>If you want to give your image a different label then ‘latest’ you can specify it as well:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag a4628dc93c97 172.30.1.1:5000/myproject/jenkins:1.0.0
docker push 172.30.1.1:5000/myproject/jenkins:1.0.0
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc get istag
</code></pre></div>    </div>
    <p>output:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME             DOCKER REF                                                                                                  UPDATED             IMAGENAME
jenkins:latest   172.30.1.1:5000/myproject/jenkins@sha256:6cab7386a27b2a8aa97d181f1d413d54a9fcb6dbfcf9b98d53bcff64ad05726b   About an hour ago   sha256:6cab7386a27b2a8aa97d181f1d413d54a9fcb6dbfcf9b98d53bcff64ad05726b
jenkins:1.0.0    172.30.1.1:5000/myproject/jenkins@sha256:0e1b8efd34dc13e721b231cab8c7e07fda5b03a14ef451874580c01fc1c2740d   27 seconds ago      sha256:0e1b8efd34dc13e721b231cab8c7e07fda5b03a14ef451874580c01fc1c2740d
</code></pre></div>    </div>
  </li>
  <li>create a new application from the uploaded image
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc new-app --image-stream=jenkins --name=jenkins
</code></pre></div>    </div>
  </li>
  <li>expose a route for the new application
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc expose service jenkins
</code></pre></div>    </div>
  </li>
</ul>]]></content><author><name>Torsten Walter</name></author><category term="minishift" /><category term="openshift" /><category term="docker" /><category term="registry" /><summary type="html"><![CDATA[Steps needed to push docker images to the Minishift docker registry.]]></summary></entry><entry><title type="html">Installing Minishift on OS X</title><link href="https://torstenwalter.de/minishift/openshift/homebrew/2017/07/18/install-minishift-on-osx.html" rel="alternate" type="text/html" title="Installing Minishift on OS X" /><published>2017-07-18T12:30:00+00:00</published><updated>2017-07-18T12:30:00+00:00</updated><id>https://torstenwalter.de/minishift/openshift/homebrew/2017/07/18/install-minishift-on-osx</id><content type="html" xml:base="https://torstenwalter.de/minishift/openshift/homebrew/2017/07/18/install-minishift-on-osx.html"><![CDATA[<p>If you want to play around with OpenShift locally then Minishift is a nice option.</p>

<p>When I tried to install it then I got an error message that the openshift docker image could not be loaded.
Luckily this <a href="https://github.com/minishift/minishift/issues/109#issuecomment-254895497">comment</a> pointed me
in the right direction, that DNS was not working properly.</p>

<h2 id="install-dnsmasq">Install dnsmasq</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew update
brew install dnsmasq
</code></pre></div></div>

<p>Edit /usr/local/etc/dnsmasq.conf to configure dnsmasq to listen on all network interfaces:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listen-address=0.0.0.0
listen-address=::1
</code></pre></div></div>

<p>Restart dnsmasq</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo brew services restart dnsmasq
</code></pre></div></div>

<p>test if nameserver listens on all ip adresses</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># use 127.0.0.1 to lookup index.docker.io
nslookup index.docker.io 127.0.0.1
# use 192.168.64.1 to lookup index.docker.io
nslookup index.docker.io 192.168.64.1
</code></pre></div></div>

<h2 id="install-minishift">Install Minishift</h2>

<h3 id="install-yhyve">Install yhyve</h3>
<p>https://docs.openshift.org/latest/minishift/getting-started/setting-up-driver-plugin.html</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install xhyve
brew install docker-machine-driver-xhyve
</code></pre></div></div>

<h3 id="install-virtualbox">Install VirtualBox</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew cask install virtualbox
</code></pre></div></div>

<h3 id="install-minishift-1">Install Minishift</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew cask install minishift
minishift start
</code></pre></div></div>

<p>alternatively you could start minishift using different disk size or memory parameters</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minishift start --disk-size 100g --memory 4096
</code></pre></div></div>]]></content><author><name>Torsten Walter</name></author><category term="minishift" /><category term="openshift" /><category term="homebrew" /><summary type="html"><![CDATA[Explains how to install Minishift as a local development alternative for OpenShift.]]></summary></entry><entry><title type="html">Continuous Delivery with Maven and Jenkins</title><link href="https://torstenwalter.de/maven/jenkins/2016/12/14/continuous-delivery-with-maven-and-jenkins.html" rel="alternate" type="text/html" title="Continuous Delivery with Maven and Jenkins" /><published>2016-12-14T12:30:00+00:00</published><updated>2016-12-14T12:30:00+00:00</updated><id>https://torstenwalter.de/maven/jenkins/2016/12/14/continuous-delivery-with-maven-and-jenkins</id><content type="html" xml:base="https://torstenwalter.de/maven/jenkins/2016/12/14/continuous-delivery-with-maven-and-jenkins.html"><![CDATA[<p>Motivation: Every jenkins build produces a potential release and as such each build should have a unique version number.
This post shows how to use the Jenkins build number to archive this.</p>

<p>The basic idea is to use a variable as part of the &lt;version&gt;…&lt;/version&gt; declaration in your pom.xml. This variable
is set to 1.0-SNAPSHOT by default for local builds and when executed on jenkins to ‘1.0-&lt;BUILD_NUMBER&gt;’.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>de.torstenwalter.examples<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jenkins-versioning<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${revision}<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;baseRevision&gt;</span>1.0<span class="nt">&lt;/baseRevision&gt;</span>
        <span class="nt">&lt;revision&gt;</span>${baseRevision}-SNAPSHOT<span class="nt">&lt;/revision&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;profiles&gt;</span>
        <span class="nt">&lt;profile&gt;</span>
            <span class="nt">&lt;id&gt;</span>jenkins<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;activation&gt;</span>
                <span class="nt">&lt;property&gt;</span>
                    <span class="nt">&lt;name&gt;</span>env.BUILD_NUMBER<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;/property&gt;</span>
            <span class="nt">&lt;/activation&gt;</span>
            <span class="nt">&lt;properties&gt;</span>
                <span class="nt">&lt;revision&gt;</span>${baseRevision}-${env.BUILD_NUMBER}<span class="nt">&lt;/revision&gt;</span>
            <span class="nt">&lt;/properties&gt;</span>
        <span class="nt">&lt;/profile&gt;</span>
    <span class="nt">&lt;/profiles&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre></figure>

<p>As variable name for the version <code class="language-plaintext highlighter-rouge">${revision}</code> is used as it is explicitly allowed since maven 3.2.1  at that location
(see <a href="https://issues.apache.org/jira/browse/MNG-5576">improvement MNG-5576</a>).</p>

<p>This is the warning if you try to use a different variable name e.g. ${myVar} instead of ${revision}:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[WARNING] Some problems were encountered while building the effective model for de.torstenwalter.examples:jenkins-versioning:jar:${myVar}
[WARNING] 'version' contains an expression but should be a constant. @ line 7, column 14
[WARNING]
[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.
[WARNING]
[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.
[WARNING]
</code></pre></div></div>

<p>This snippet sets the default value for revision to 1.0-SNAPSHOT:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;baseRevision&gt;</span>1.0<span class="nt">&lt;/baseRevision&gt;</span>
        <span class="nt">&lt;revision&gt;</span>${baseRevision}-SNAPSHOT<span class="nt">&lt;/revision&gt;</span>
    <span class="nt">&lt;/properties&gt;</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">baseRevision</code> is meant to provide the base version e.g. 1.0 or 2.3 where the build number is later appended or -LATEST for
local builds.</p>

<p>The build number is included as part of the version by using a maven profile which is automatically enabled when the 
environment variable <code class="language-plaintext highlighter-rouge">BUILD_NUMBER</code> is present.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">        <span class="nt">&lt;profile&gt;</span>
            <span class="nt">&lt;id&gt;</span>jenkins<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;activation&gt;</span>
                <span class="nt">&lt;property&gt;</span>
                    <span class="nt">&lt;name&gt;</span>env.BUILD_NUMBER<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;/property&gt;</span>
            <span class="nt">&lt;/activation&gt;</span>
            <span class="nt">&lt;properties&gt;</span>
                <span class="nt">&lt;revision&gt;</span>${baseRevision}-${env.BUILD_NUMBER}<span class="nt">&lt;/revision&gt;</span>
            <span class="nt">&lt;/properties&gt;</span>
        <span class="nt">&lt;/profile&gt;</span></code></pre></figure>]]></content><author><name>Torsten Walter</name></author><category term="maven" /><category term="jenkins" /><summary type="html"><![CDATA[How to automatically create unique version numbers with Maven in Jenkins.]]></summary></entry></feed>